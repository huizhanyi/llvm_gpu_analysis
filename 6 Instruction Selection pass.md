![image](https://github.com/huizhanyi/llvm_gpu_analysis/blob/main/SelectionDAG_Overview.png)
这里对NVPTX DAG->DAG Pattern Instruction Selection进行详细分析
```
llc -mcpu=sm_60 -mattr=+ptx83 axpy-cuda-nvptx64-nvidia-cuda-sm_60.bc -debug-only=isel
llc -mcpu=sm_60 -mattr=+ptx83 axpy-cuda-nvptx64-nvidia-cuda-sm_60.bc -view-dag-combine1-dags
```
NVPTXISelDAGToDAG.cpp/NVPTXISelDAGToDAG.h
```
class LLVM_LIBRARY_VISIBILITY NVPTXDAGToDAGISel : public SelectionDAGISel {
```
NVPTXISelDAGToDAG.cpp
```
  33 /// createNVPTXISelDag - This pass converts a legalized DAG into a
  34 /// NVPTX-specific DAG, ready for instruction scheduling.
  35 FunctionPass *llvm::createNVPTXISelDag(NVPTXTargetMachine &TM,
  36                                        llvm::CodeGenOptLevel OptLevel) {
  37   return new NVPTXDAGToDAGISel(TM, OptLevel);
  38 }

  44 NVPTXDAGToDAGISel::NVPTXDAGToDAGISel(NVPTXTargetMachine &tm,
  45                                      CodeGenOptLevel OptLevel)
  46     : SelectionDAGISel(ID, tm, OptLevel), TM(tm) {
  47   doMulWide = (OptLevel > CodeGenOptLevel::None);
  48 }
```
生成具体的PASS类，指定TargetMachine和优化层次。
NVPTXISelDAGToDAG.h
```
 28 class LLVM_LIBRARY_VISIBILITY NVPTXDAGToDAGISel : public SelectionDAGISel {
 48   bool runOnMachineFunction(MachineFunction &MF) override;
入口函数
 56 // Include the pieces autogenerated from the target description.
 57 #include "NVPTXGenDAGISel.inc"
包括自动生成的部分，这里面包括几个函数SelectCode、CheckPatternPredicate、CheckNodePredicate、CheckComplexPattern、RunSDNodeXForm、，这里成为类的方法。
```
NVPTXISelDAGToDAG.cpp
```
  50 bool NVPTXDAGToDAGISel::runOnMachineFunction(MachineFunction &MF) {
  51   Subtarget = &MF.getSubtarget<NVPTXSubtarget>();
返回NVPTXSubtarget类
  52   return SelectionDAGISel::runOnMachineFunction(MF);
调用父类的函数
  53 }
```
NVPTXSubtarget.h
```
 26 #define GET_SUBTARGETINFO_HEADER
 27 #include "NVPTXGenSubtargetInfo.inc"
 28
 31 class NVPTXSubtarget : public NVPTXGenSubtargetInfo {
```
自动生成，用于提供target的不同特性支持情况
